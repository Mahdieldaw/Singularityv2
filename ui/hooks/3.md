
2. Fix "Significant text regression" (The Claude Warning)

The Cause:
Your Service Worker (makeDelta function) identifies streams using only ${sessionId}:${providerId}.

Claude finishes Synthesis (Text length: 8216 chars).

Claude starts Mapping (Text length: 0 chars).

The Service Worker sees sessionId:claude went from 8216 -> 11.

It thinks the stream broke/regressed and logs a warning.

The Solution:
Update makeDelta in  workflow-engine.js to include the stepId in the cache key. This treats the Synthesis step and Mapping step as two separate streams.

In workflow-engine.js (or wherever makeDelta is defined):

Change the function signature and key generation:

code
JavaScript
download
content_copy
expand_less
// 1. Update the function signature to accept stepId
function makeDelta(sessionId, stepId, providerId, fullText = "") { // Added stepId
  if (!sessionId) return fullText || "";

  // 2. Update the Key to be unique per step
  const key = `${sessionId}:${stepId}:${providerId}`; 
  
  const prev = lastStreamState.get(key) || "";
  // ... rest of logic remains the same ...
}

Then update where it is called (usually inside WorkflowEngine.js -> _dispatchPartialDelta):

code
JavaScript
download
content_copy
expand_less
// inside WorkflowEngine class
_dispatchPartialDelta(sessionId, stepId, providerId, text, label = null, isFinal = false) {
  try {
    // Pass stepId here
    const delta = makeDelta(sessionId, stepId, providerId, text); 
    
    // ... rest of function
